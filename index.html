<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ETC LOGI.SYNC | Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap');
        
        :root {
            /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
            --bg-page: #FFFFFF;
            --bg-card: #F6F8FA;
            --border-ui: #D0D7DE;
            --text-main: #1F2328;
            --text-secondary: #656D76;
            --accent-sky: #0969da;
            --accent-green: #1a7f37;
            --accent-red: #d1242f;
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        body.dark-night {
            --bg-page: #0D1117;
            --bg-card: #161B22;
            --border-ui: #30363D;
            --text-main: #F0F6FC;
            --text-secondary: #8B949E;
            --accent-sky: #38bdf8;
        }

        body { 
            background-color: var(--bg-page);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            transition: background-color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 1rem env(safe-area-inset-bottom);
        }

        .cyber-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-ui);
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            margin: auto 0;
            height: 90vh;
            max-height: 800px;
            position: relative;
            transition: all var(--transition-smooth);
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        @media (max-height: 600px) {
            .cyber-card { height: 100vh; max-height: none; border-radius: 0; border: none; }
            .app-container { padding: 0; }
        }

        .logo-text { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.05em; }

        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            background-color: var(--bg-page);
            border: 1px solid var(--border-ui);
            border-radius: 1rem;
            color: var(--text-main);
            width: 100%;
            padding: 1rem 3.5rem 1rem 1rem;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
            text-align: left;
        }
        .search-input:focus { border-color: var(--accent-sky); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1); }

        .voice-btn {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-sky);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 0.75rem;
            z-index: 5;
            transition: background 0.2s;
        }
        .voice-btn:hover { background: rgba(56, 189, 248, 0.1); }
        .voice-btn.recording { color: var(--accent-red); animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0% { transform: translateY(-50%) scale(1); opacity: 1; }
            50% { transform: translateY(-50%) scale(1.2); opacity: 0.7; }
            100% { transform: translateY(-50%) scale(1); opacity: 1; }
        }

        .supplier-list {
            background-color: var(--bg-page);
            border-top: 1px solid var(--border-ui);
            border-bottom: 1px solid var(--border-ui);
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .supplier-item {
            display: flex;
            align-items: center;
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--border-ui);
            cursor: pointer;
            transition: background 0.2s;
        }
        .supplier-item:active { background-color: rgba(0,0,0,0.05); }
        body.dark-night .supplier-item:active { background-color: rgba(255,255,255,0.05); }

        .custom-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-ui);
            border-radius: 8px;
            margin-right: 1rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .supplier-item.selected .custom-checkbox {
            background-color: var(--accent-sky);
            border-color: var(--accent-sky);
        }
        .supplier-item.selected .custom-checkbox::after { content: '‚úì'; color: white; font-weight: 900; }

        .action-btn {
            padding: 1.25rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .action-btn:active { transform: scale(0.96); }
        
        #arriveBtn { background-color: var(--accent-sky); color: white; border-radius: 1rem; }
        #arriveBtn:disabled { opacity: 0.3; transform: none; }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 10;
        }

        /* –¶–≤–µ—Ç–∞ –∏–∫–æ–Ω–æ–∫ */
        .icon-sun { color: #FFD700; filter: drop-shadow(0 0 2px rgba(0,0,0,0.2)); } 
        .icon-moon { 
            color: #FFFFFF; 
            filter: drop-shadow(0 0 1px rgba(0,0,0,0.8)) drop-shadow(0 0 3px rgba(0,0,0,0.3)); 
        }

        #respectOverlay {
            position: fixed;
            inset: 0;
            background: var(--bg-page);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 2rem;
            text-align: center;
        }
    </style>
</head>
<body id="mainBody" class="dark-night">

    <div id="respectOverlay">
        <div class="mb-6 p-6 bg-emerald-500/10 rounded-full">
             <svg class="text-emerald-500 w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <h2 class="logo-text text-3xl text-emerald-500 mb-2">–£–í–ê–ñ–ï–ù–ò–ï +100</h2>
        <p id="dateTimeDisplay" class="font-mono text-lg font-bold opacity-80 mb-10 tracking-widest"></p>
        <button onclick="closeRespect()" class="w-full max-w-xs py-4 bg-emerald-500 text-white font-black rounded-2xl shadow-xl shadow-emerald-500/20 uppercase">–ü—Ä–∏–Ω—è—Ç–æ</button>
    </div>

    <div class="app-container">
        <div class="cyber-card">
            <div class="p-6 flex flex-col items-center relative">
                <div class="theme-toggle" onclick="toggleTheme()">
                    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle class="icon-sun" cx="12" cy="12" r="4"/><path class="icon-sun" d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
                    </svg>
                </div>
                <h1 class="logo-text text-2xl font-bold italic text-center" style="color: var(--text-main)">
                    <span style="color: var(--accent-sky)">ETC</span> LOGI.SYNC
                </h1>
            </div>

            <div class="px-6 pb-4">
                <p class="text-[10px] font-black opacity-50 uppercase tracking-widest text-center">
                    –í–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª –≤–æ–¥–∏—Ç–µ–ª—è, –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–∑–æ–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è... üöõ
                </p>
            </div>

            <div id="supplierList" class="supplier-list">
                <div id="listInner">
                    <div class="p-10 text-center opacity-40 italic text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤...</div>
                </div>
            </div>

            <div class="p-6 space-y-4 bg-inherit">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–∏..." class="search-input" autocomplete="off">
                    <button id="voiceBtn" class="voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–∏—Å–∫">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    </button>
                </div>

                <div class="flex flex-col gap-3">
                    <button id="arriveBtn" disabled class="action-btn w-full text-lg">
                        —Ñ—É—Ö, –¥–æ–µ—Ö–∞–ª!
                    </button>
                    <button id="cancelBtn" class="py-2 text-xs font-bold uppercase opacity-60 text-red-500 hidden">
                        –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'logisync-mobile-v3';
                    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll([location.href]))));
                    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
                `;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-night');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            const isDark = document.body.classList.contains('dark-night');
            if (isDark) {
                icon.innerHTML = '<circle class="icon-sun" cx="12" cy="12" r="4"/><path class="icon-sun" d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>';
            } else {
                icon.innerHTML = '<path class="icon-moon" d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>';
            }
        }

        // –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–∏—Å–∫
        const voiceBtn = document.getElementById('voiceBtn');
        const searchInput = document.getElementById('searchInput');
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'ru-RU';
            recognition.continuous = false;
            recognition.interimResults = false;

            voiceBtn.onclick = () => {
                try {
                    recognition.start();
                    voiceBtn.classList.add('recording');
                } catch(e) {
                    recognition.stop();
                }
            };

            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                searchInput.value = transcript;
                renderSuppliers();
                voiceBtn.classList.remove('recording');
            };

            recognition.onerror = () => voiceBtn.classList.remove('recording');
            recognition.onend = () => voiceBtn.classList.remove('recording');
        } else {
            voiceBtn.style.display = 'none';
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCXXDGFTzEz7vzvgPM9rpV4dddlcfnnzLU",
            authDomain: "main-f6446.firebaseapp.com",
            projectId: "main-f6446",
            appId: "1:733541253938:web:67d2af040d637199050d2b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = 'supplier-tracker-v1';

        let allSuppliers = [];
        let selectedIds = new Set();

        async function init() {
            await auth.signInAnonymously();
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('suppliers')
              .onSnapshot(snap => {
                  allSuppliers = [];
                  snap.forEach(doc => allSuppliers.push({ id: doc.id, ...doc.data() }));
                  allSuppliers.sort((a, b) => (a.status === 'arrived') - (b.status === 'arrived') || a.name.localeCompare(b.name));
                  renderSuppliers();
              });
            updateThemeIcon();
        }

        function renderSuppliers() {
            const inner = document.getElementById('listInner');
            const search = searchInput.value.toLowerCase();
            inner.innerHTML = '';
            
            const filtered = allSuppliers.filter(s => s.name.toLowerCase().includes(search));
            
            filtered.forEach(s => {
                const arrived = s.status === 'arrived';
                const item = document.createElement('div');
                item.className = `supplier-item ${selectedIds.has(s.id) ? 'selected' : ''}`;
                if (arrived) item.style.opacity = '0.4';

                item.innerHTML = `
                    <div class="custom-checkbox"></div>
                    <div class="flex-grow">
                        <div class="font-bold text-sm uppercase">${s.name}</div>
                        ${arrived ? `<div class="text-[9px] text-emerald-500 font-black">–ü–†–ò–ë–´–õ –í ${s.arrivalTime}</div>` : ''}
                    </div>
                `;

                item.onclick = () => {
                    if (arrived) return;
                    selectedIds.has(s.id) ? selectedIds.delete(s.id) : selectedIds.add(s.id);
                    renderSuppliers();
                    updateButtons();
                };
                inner.appendChild(item);
            });
        }

        function updateButtons() {
            const btn = document.getElementById('arriveBtn');
            const cancel = document.getElementById('cancelBtn');
            btn.disabled = selectedIds.size === 0;
            btn.textContent = selectedIds.size > 0 ? `—Ñ—É—Ö, –¥–æ–µ—Ö–∞–ª! (${selectedIds.size})` : '—Ñ—É—Ö, –¥–æ–µ—Ö–∞–ª!';
            cancel.classList.toggle('hidden', selectedIds.size === 0);
        }

        document.getElementById('cancelBtn').onclick = () => {
            selectedIds.clear();
            renderSuppliers();
            updateButtons();
        };

        document.getElementById('arriveBtn').onclick = async () => {
            const btn = document.getElementById('arriveBtn');
            btn.disabled = true;
            btn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const fullDateTime = `${day}.${month}.${year} | ${timeStr}`;
            
            const batch = db.batch();
            
            selectedIds.forEach(id => {
                const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('suppliers').doc(id);
                batch.update(ref, { status: 'arrived', arrivalTime: timeStr });
            });

            await batch.commit();
            
            document.getElementById('dateTimeDisplay').textContent = fullDateTime;
            document.getElementById('respectOverlay').style.display = 'flex';
            
            selectedIds.clear();
            searchInput.value = '';
            updateButtons();
        };

        function closeRespect() { document.getElementById('respectOverlay').style.display = 'none'; }
        searchInput.oninput = renderSuppliers;

        init();
    </script>
</body>
</html>
