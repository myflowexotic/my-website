<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETC LOGI.SYNC | Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap');
        
        :root {
            --bg-page: #1e293b;
            --bg-card: #0f172a;
            --border-ui: #334155;
            --text-main: #f8fafc;
            --accent-sky: #38bdf8;
            --accent-green: #10b981;
            --accent-red: #ef4444;
        }

        body { 
            background-color: var(--bg-page);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .cyber-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-ui);
            border-radius: 2rem;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            position: relative;
        }

        .logo-text { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.05em; }

        .search-input {
            background-color: var(--bg-page);
            border: 1px solid var(--border-ui);
            border-radius: 0.75rem;
            color: var(--text-main);
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 0.75rem;
        }
        .search-input:focus { border-color: var(--accent-sky); }

        .supplier-list {
            background-color: var(--bg-page);
            border: 1px solid var(--border-ui);
            border-radius: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .supplier-list::-webkit-scrollbar { width: 4px; }
        .supplier-list::-webkit-scrollbar-thumb { background: var(--border-ui); border-radius: 10px; }

        .supplier-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            cursor: pointer;
            transition: background 0.2s;
        }
        .supplier-item:active { background: rgba(56, 189, 248, 0.05); }

        .custom-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-ui);
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .supplier-item.selected .custom-checkbox {
            background-color: var(--accent-sky);
            border-color: var(--accent-sky);
        }
        .supplier-item.selected .custom-checkbox::after {
            content: '✓';
            color: var(--bg-card);
            font-weight: 900;
            font-size: 14px;
        }

        #arriveBtn {
            background-color: var(--accent-sky);
            color: var(--bg-card);
            font-weight: 900;
            text-transform: uppercase;
            transition: all 0.2s ease;
            border: none;
        }
        #arriveBtn:disabled { opacity: 0.3; filter: grayscale(1); }

        #respectOverlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.98);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn 0.3s ease-out;
            text-align: center;
            padding: 2rem;
        }
        
        .respect-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-green);
            text-shadow: 0 0 30px rgba(16, 185, 129, 0.4);
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            animation: stamp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes stamp { 0% { transform: scale(2); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .live-indicator {
            width: 8px; height: 8px; background-color: var(--accent-red);
            border-radius: 50%; box-shadow: 0 0 10px var(--accent-red);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="respectOverlay">
        <h2 class="respect-title">Уважение к вам увеличилось</h2>
        <p id="arrivalInfo" class="text-white font-bold tracking-widest uppercase text-lg mb-2">Ваша дата прибытия: --:--</p>
        <div class="mt-12 flex flex-col items-center gap-4">
            <button onclick="closeRespect()" class="px-12 py-4 rounded-2xl bg-emerald-500 text-white font-black text-xl hover:bg-emerald-400 transition-all shadow-xl shadow-emerald-900/20 active:scale-95">ЗАКРЫТЬ</button>
            <p class="text-slate-500 font-bold uppercase text-[10px] tracking-[0.2em]">Закройте после прибытия</p>
        </div>
    </div>

    <div class="p-4 w-full flex justify-center">
        <div class="cyber-card p-8">
            <div class="text-center mb-6">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <span class="live-indicator"></span>
                    <span class="text-[10px] font-bold text-slate-500 tracking-[0.3em] uppercase">ETC LOGI.SYNC</span>
                </div>
                <h1 class="logo-text text-3xl font-bold text-white italic">
                    <span style="color: var(--accent-sky)">ETC</span> LOGI.SYNC
                </h1>
            </div>

            <div class="space-y-6">
                <div>
                    <p class="text-[13px] font-bold text-slate-400 uppercase tracking-wide mb-4 text-center">Выберите поставщика/ов</p>
                    <input type="text" id="searchInput" placeholder="Поиск по названию..." class="search-input" autocomplete="off">
                    <div id="supplierList" class="supplier-list">
                        <div class="p-8 text-center text-slate-500 text-xs italic">Загрузка списка...</div>
                    </div>
                </div>
                <button id="arriveBtn" disabled class="w-full py-5 rounded-2xl text-xl italic tracking-tighter">Фух, доехал!</button>
            </div>
        </div>
    </div>

    <script>
        const INITIAL_SUPPLIERS = ["АвтоБот", "АвтоНова", "АвтоПалас", "АвтоСпейс", "АвтоТракМоторс", "Автоцентр Север", "АгроФильтр", "Альтра", "Аобел", "Автовар", "АС Север", "Автогаз", "АвтоИдея", "АвтоТраст", "Агромаш", "Аквилон", "АвтоАмазис", "Атлант Премиум", "Боровая", "БЭР-Авто", "БАМС", "Белагро", "БелИнвестЗапчасть", "БелИнвесТорг", "БелМоторДеталь", "БелОил", "БелСтартер", "БелТБ", "Боникс", "ВАЙБЕР", "Визит-Фвто", "Виланд", "ГаммаПлюс", "ГрандОйл", "Диал", "Диас", "Дизель-Кама", "Дюкон", "Дэлвин", "ЕвроЗапчасть", "Запад", "Инструментальный", "ИнтСелПартс", "КарПротект", "КолесоПлюс", "Крипан", "Л-авто", "Лада", "Ленсвязь", "Линник", "Мазикбай", "Мари", "Микро Альянс", "Модников", "Монлибон", "Мотехс", "МоторАвтоГрад", "Немецкая тройка", "НикадагАвто", "ОЕМ", "ЛОйл", "Омега", "ОстХим", "Парад", "ПартсБест", "Почта", "ПС АвтоГруп", "РемАвтоСнаб", "РимБат", "РосАвтоком", "Свиат", "СиванаБел", "Сплат", "ТГ", "ТрансКонсалт(1п)", "ТрансКонсалт(2п)", "ТрансКонсалт(3п)", "ТурбоТракс", "Фелокт", "Фильтрация", "Форвард", "Форсаж", "Фострейд", "Францемоторс", "Центр (Восток)", "Шате", "Эквипмент", "ЭкспертОйл", "Энергия"];

        const firebaseConfig = {
            apiKey: "AIzaSyCXXDGFTzEz7vzvgPM9rpV4dddlcfnnzLU",
            authDomain: "main-f6446.firebaseapp.com",
            projectId: "main-f6446",
            storageBucket: "main-f6446.firebasestorage.app",
            messagingSenderId: "733541253938",
            appId: "1:733541253938:web:67d2af040d637199050d2b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = 'supplier-tracker-v1';

        let selectedSuppliers = new Set();
        let allSuppliers = [];

        async function init() {
            try {
                await auth.signInAnonymously();
                const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('suppliers');
                
                // Проверка на пустоту и автозаполнение
                const snapshot = await colRef.get();
                if (snapshot.empty) {
                    const batch = db.batch();
                    INITIAL_SUPPLIERS.forEach(name => {
                        const id = name.replace(/\s+/g, '_').toLowerCase();
                        batch.set(colRef.doc(id), {
                            name: name,
                            email: "",
                            status: "absent",
                            arrivalTime: null,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    await batch.commit();
                }

                // Подписка на обновления
                colRef.onSnapshot(snap => {
                    allSuppliers = [];
                    snap.forEach(doc => allSuppliers.push({ id: doc.id, ...doc.data() }));
                    allSuppliers.sort((a, b) => a.name.localeCompare(b.name));
                    renderSuppliers(allSuppliers);
                });

            } catch (e) { console.error(e); }
        }

        function renderSuppliers(list) {
            const listContainer = document.getElementById('supplierList');
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            listContainer.innerHTML = '';
            
            list.forEach(s => {
                if (searchValue && !s.name.toLowerCase().includes(searchValue)) return;
                
                const div = document.createElement('div');
                div.className = 'supplier-item' + (selectedSuppliers.has(s.id) ? ' selected' : '');
                div.innerHTML = `
                    <div class="custom-checkbox"></div>
                    <div class="flex flex-col">
                        <span class="font-bold text-sm uppercase">${s.name}</span>
                        ${s.status === 'arrived' ? `<span class="text-[10px] text-emerald-400 font-bold uppercase">Уже прибыл в ${s.arrivalTime}</span>` : ''}
                    </div>
                `;
                div.onclick = () => toggleSupplier(div, s.id);
                listContainer.appendChild(div);
            });
        }

        document.getElementById('searchInput').addEventListener('input', () => renderSuppliers(allSuppliers));

        function toggleSupplier(element, id) {
            if (selectedSuppliers.has(id)) {
                selectedSuppliers.delete(id);
                element.classList.remove('selected');
            } else {
                selectedSuppliers.add(id);
                element.classList.add('selected');
            }
            
            const btn = document.getElementById('arriveBtn');
            const count = selectedSuppliers.size;
            btn.disabled = count === 0;
            btn.textContent = count > 0 ? `Фух, доехал! (${count})` : "Фух, доехал!";
        }

        function closeRespect() {
            document.getElementById('respectOverlay').style.display = 'none';
        }

        document.getElementById('arriveBtn').addEventListener('click', async () => {
            if (selectedSuppliers.size === 0) return;

            const btn = document.getElementById('arriveBtn');
            btn.disabled = true;
            btn.textContent = "СИНХРОНИЗАЦИЯ...";

            try {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                const batch = db.batch();
                
                selectedSuppliers.forEach(sid => {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('suppliers').doc(sid);
                    batch.update(docRef, {
                        status: 'arrived',
                        arrivalTime: timeStr,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await batch.commit();

                document.getElementById('arrivalInfo').textContent = `Ваша дата прибытия: ${timeStr}`;
                document.getElementById('respectOverlay').style.display = 'flex';

                selectedSuppliers.clear();
                btn.textContent = "Фух, доехал!";
                btn.disabled = true;
                document.getElementById('searchInput').value = '';
                renderSuppliers(allSuppliers);

            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.textContent = "ОШИБКА СЕТИ";
            }
        });

        init();
    </script>
</body>
</html>
